generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum PartnerType {
  VC
  CORPORATE
  COMMUNITY_BUILDER
  ANGEL
  OTHER
}

enum OnboardingStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  ABANDONED
}

enum OutreachStatus {
  PENDING
  APPROVED
  SENT
  SKIPPED
  DELETED
}

enum DigestStatus {
  DRAFT
  APPROVED
  SENT
}

enum ResearchType {
  LINKEDIN
  PERSON_NEWS
  FIRM_INFO
  SOCIAL_PRESENCE
  PERSON_BACKGROUND    // Wikipedia person data
  COMPANY_BACKGROUND   // Wikipedia company data
  CITATION_CRAWL       // Crawled article from citation
  TWITTER_PROFILE      // Twitter/X profile and tweets
  REDDIT_ACTIVITY      // Reddit posts and comments
  PODCAST_ANALYSIS     // Podcast transcription and analysis
}

enum ResearchStatus {
  PENDING
  IN_PROGRESS
  SUCCESS
  FAILED
  RATE_LIMITED
}

enum FactCheckStatus {
  UNVERIFIED
  VERIFIED
  PARTIALLY_VERIFIED
  DISPUTED
  CONTRADICTED
}

enum FirmType {
  VC
  CORPORATE
  ANGEL_NETWORK
  ACCELERATOR
  FAMILY_OFFICE
  OTHER
}

// Partner profiles populated from AI onboarding
model Partner {
  id                    String        @id @default(uuid())
  slackUserId           String        @unique @map("slack_user_id")
  slackHandle           String?       @map("slack_handle")
  name                  String
  email                 String?
  firm                  String
  role                  String?
  partnerType           PartnerType   @map("partner_type")
  
  // Investment/Partnership details
  sectors               String[]      @default([])
  stageFocus            String[]      @default([]) @map("stage_focus")
  checkSize             String?       @map("check_size")
  geographicFocus       String[]      @default([]) @map("geographic_focus")
  
  // Profile details
  idealFounderProfile   String?       @map("ideal_founder_profile")
  engagementPreferences String[]      @default([]) @map("engagement_preferences")
  contributionOffers    String[]      @default([]) @map("contribution_offers")
  goalsFromCommunity    String?       @map("goals_from_community")
  linkedinUrl           String?       @map("linkedin_url")
  
  // Onboarding
  onboardingComplete    Boolean       @default(false) @map("onboarding_complete")
  onboardingData        Json?         @map("onboarding_data")
  
  // Research data (denormalized for quick access)
  researchSummary       Json?         @map("research_summary")
  researchStatus        ResearchStatus? @map("research_status")
  researchCompletedAt   DateTime?     @map("research_completed_at")
  
  // Relationships
  conversations         OnboardingConversation[]
  outreachMessages      OutreachMessage[]
  research              PartnerResearch[]
  
  createdAt             DateTime      @default(now()) @map("created_at")
  updatedAt             DateTime      @updatedAt @map("updated_at")

  @@map("partners")
}

// Research data collected on partners from various sources
model PartnerResearch {
  id              String         @id @default(uuid())
  partnerId       String         @map("partner_id")
  partner         Partner        @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  // Research classification
  researchType    ResearchType   @map("research_type")
  source          String         // API used: linkedin_scraper, perplexity, tavily
  query           String?        // Search query used
  
  // Raw and structured data
  rawData         Json           @map("raw_data")
  structuredData  Json?          @map("structured_data")
  
  // Quality and freshness tracking
  confidence      Float?         // 0-1 confidence score
  status          ResearchStatus @default(PENDING)
  errorMessage    String?        @map("error_message")
  
  scrapedAt       DateTime?      @map("scraped_at")
  expiresAt       DateTime?      @map("expires_at")
  
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")

  @@index([partnerId])
  @@index([researchType])
  @@map("partner_research")
}

// Aggregated person profile from all research sources
model PersonProfile {
  id                String    @id @default(uuid())
  partnerId         String    @unique @map("partner_id")
  
  // Core Identity
  name              String
  linkedinUrl       String?   @map("linkedin_url")
  twitterUrl        String?   @map("twitter_url")
  email             String?
  location          String?
  photoUrl          String?   @map("photo_url")
  headline          String?
  
  // Career (JSON arrays)
  careerTimeline    Json?     @map("career_timeline")    // [{company, role, startDate, endDate, highlights}]
  education         Json?                                 // [{school, degree, field, year}]
  
  // Investment/Professional Focus
  investmentThesis  String?   @map("investment_thesis")
  sectors           String[]  @default([])
  stageFocus        String[]  @default([]) @map("stage_focus")
  checkSizeRange    String?   @map("check_size_range")
  
  // Achievements & Recognition (JSON arrays)
  notableDeals      Json?     @map("notable_deals")      // [{company, round, amount, date, outcome}]
  awards            Json?                                 // [{name, year, organization}]
  pressFeatures     Json?     @map("press_features")     // [{publication, title, url, date}]
  speakingEvents    Json?     @map("speaking_events")    // [{event, topic, date}]
  
  // Content & Thought Leadership (JSON arrays)
  publications      Json?                                 // [{title, url, type, date}]
  podcasts          Json?                                 // [{show, episode, url, date}]
  socialContent     Json?     @map("social_content")     // Recent interesting tweets/posts
  
  // Personal (for engaging intros)
  funFacts          String[]  @default([]) @map("fun_facts")
  interests         String[]  @default([])
  quotableQuotes    String[]  @default([]) @map("quotable_quotes")
  
  // AI-Generated Summaries
  shortBio          String?   @map("short_bio")          // 2-3 sentence summary
  introSummary      String?   @map("intro_summary")      // Rich intro for Slack
  connectionAngles  Json?     @map("connection_angles")  // Ways to connect with community
  
  // Quality & Metadata
  dataQualityScore  Float     @default(0) @map("data_quality_score")
  factCheckScore    Float     @default(0) @map("fact_check_score")
  sourcesUsed       String[]  @default([]) @map("sources_used")
  lastResearchAt    DateTime? @map("last_research_at")
  
  // Relationship to firm
  firmProfileId     String?   @map("firm_profile_id")
  firmProfile       FirmProfile? @relation(fields: [firmProfileId], references: [id])
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("person_profiles")
}

// Aggregated firm/company profile (multi-person aware)
model FirmProfile {
  id                String    @id @default(uuid())
  
  // Core Identity
  name              String    @unique
  type              FirmType
  foundedYear       Int?      @map("founded_year")
  headquarters      String?
  website           String?
  linkedinUrl       String?   @map("linkedin_url")
  description       String?
  
  // Investment Profile (for VC/Investment firms)
  aum               String?   // Assets under management
  fundCount         Int?      @map("fund_count")
  portfolioSize     Int?      @map("portfolio_size")
  investmentThesis  String?   @map("investment_thesis")
  sectorFocus       String[]  @default([]) @map("sector_focus")
  stageFocus        String[]  @default([]) @map("stage_focus")
  geographyFocus    String[]  @default([]) @map("geography_focus")
  
  // Portfolio & Track Record (JSON arrays)
  notablePortfolio  Json?     @map("notable_portfolio")  // [{company, round, outcome}]
  exits             Json?                                 // [{company, type, value, date}]
  
  // Team (JSON array)
  teamMembers       Json?     @map("team_members")       // [{name, role, linkedinUrl, partnerId}]
  partnerCount      Int?      @map("partner_count")
  
  // News & Reputation (JSON arrays)
  recentNews        Json?     @map("recent_news")        // [{title, url, date, summary}]
  fundingNews       Json?     @map("funding_news")       // Fund raises, etc.
  rankings          Json?                                 // [{source, rank, category, year}]
  
  // Quality & Metadata
  dataQualityScore  Float     @default(0) @map("data_quality_score")
  sourcesUsed       String[]  @default([]) @map("sources_used")
  lastResearchAt    DateTime? @map("last_research_at")
  
  // Relationships
  personProfiles    PersonProfile[]
  
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  @@map("firm_profiles")
}

// Crawled citation URLs from Perplexity
model CitationCrawl {
  id                  String    @id @default(uuid())
  url                 String    @unique
  domain              String
  
  // Content
  title               String?
  author              String?
  publishedDate       DateTime? @map("published_date")
  fullText            String?   @map("full_text")
  summary             String?
  
  // Extracted Facts (JSON array)
  extractedFacts      Json?     @map("extracted_facts")  // [{type, value, confidence, context}]
  mentionedPeople     String[]  @default([]) @map("mentioned_people")
  mentionedCompanies  String[]  @default([]) @map("mentioned_companies")
  
  // Quality
  trustScore          Float     @default(0.5) @map("trust_score")
  relevanceScore      Float?    @map("relevance_score")
  
  // Metadata
  httpStatus          Int?      @map("http_status")
  contentType         String?   @map("content_type")
  crawledAt           DateTime  @default(now()) @map("crawled_at")
  
  // Link back to research
  researchId          String?   @map("research_id")
  
  @@index([domain])
  @@map("citation_crawls")
}

// Verified facts with cross-reference tracking
model VerifiedFact {
  id                  String          @id @default(uuid())
  
  // The fact itself
  factType            String          @map("fact_type")   // 'investment', 'position', 'achievement', etc.
  subject             String                               // Person or company name
  value               String                               // The actual fact
  context             String?                              // Additional context
  
  // Verification
  status              FactCheckStatus @default(UNVERIFIED)
  confidence          Float           @default(0)
  corroboratingSources Json?          @map("corroborating_sources") // [{source, url, snippet}]
  contradictions      Json?                                          // [{source, url, conflictingValue}]
  
  // Relationships
  personProfileId     String?         @map("person_profile_id")
  firmProfileId       String?         @map("firm_profile_id")
  
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  @@index([factType])
  @@index([subject])
  @@map("verified_facts")
}

// Multi-turn onboarding conversation state
model OnboardingConversation {
  id            String            @id @default(uuid())
  partnerId     String?           @map("partner_id")
  partner       Partner?          @relation(fields: [partnerId], references: [id])
  slackUserId   String            @map("slack_user_id")
  messages      Json              @default("[]") // Array of {role, content, timestamp}
  extractedData Json?             @map("extracted_data") // Partial data as conversation progresses
  status        OnboardingStatus  @default(PENDING)
  
  startedAt     DateTime          @default(now()) @map("started_at")
  completedAt   DateTime?         @map("completed_at")

  @@map("onboarding_conversations")
}

// Events for outreach
model Event {
  id                  String            @id @default(uuid())
  name                String
  eventType           String            @map("event_type")
  dateTime            DateTime          @map("date_time")
  location            String?
  description         String?
  rsvpLink            String?           @map("rsvp_link")
  targetPartnerTypes  String[]          @default([]) @map("target_partner_types")
  targetSectors       String[]          @default([]) @map("target_sectors")
  
  createdBy           String            @map("created_by") // Slack user ID
  outreachMessages    OutreachMessage[]
  
  createdAt           DateTime          @default(now()) @map("created_at")

  @@map("events")
}

// Personalized outreach messages pending approval
model OutreachMessage {
  id                      String          @id @default(uuid())
  eventId                 String          @map("event_id")
  event                   Event           @relation(fields: [eventId], references: [id])
  partnerId               String          @map("partner_id")
  partner                 Partner         @relation(fields: [partnerId], references: [id])
  
  messageDraft            String          @map("message_draft")
  personalizationContext  Json?           @map("personalization_context")
  status                  OutreachStatus  @default(PENDING)
  
  approvedBy              String?         @map("approved_by") // Slack user ID
  approvedAt              DateTime?       @map("approved_at")
  sentAt                  DateTime?       @map("sent_at")
  slackMessageTs          String?         @map("slack_message_ts") // Approval message in #bot-admin
  
  createdAt               DateTime        @default(now()) @map("created_at")

  @@map("outreach_messages")
}

// Bi-weekly digests
model Digest {
  id              String        @id @default(uuid())
  periodStart     DateTime      @map("period_start")
  periodEnd       DateTime      @map("period_end")
  content         Json          // Structured digest content
  renderedMessage String?       @map("rendered_message")
  status          DigestStatus  @default(DRAFT)
  
  sentToChannel   Boolean       @default(false) @map("sent_to_channel")
  sentToDms       Boolean       @default(false) @map("sent_to_dms")
  sentAt          DateTime?     @map("sent_at")
  
  items           DigestItem[]
  
  createdAt       DateTime      @default(now()) @map("created_at")

  @@map("digests")
}

// Individual digest content items
model DigestItem {
  id        String   @id @default(uuid())
  digestId  String   @map("digest_id")
  digest    Digest   @relation(fields: [digestId], references: [id])
  itemType  String   @map("item_type") // 'highlight', 'event_recap', 'featured_founder', 'new_partner'
  content   Json
  createdBy String?  @map("created_by") // Slack user ID
  
  createdAt DateTime @default(now()) @map("created_at")

  @@map("digest_items")
}

// Activity log for audit trail
model ActivityLog {
  id           String   @id @default(uuid())
  actionType   String   @map("action_type")
  actorSlackId String?  @map("actor_slack_id")
  targetType   String?  @map("target_type") // 'partner', 'event', 'outreach', 'digest'
  targetId     String?  @map("target_id")
  metadata     Json?
  
  createdAt    DateTime @default(now()) @map("created_at")

  @@index([createdAt])
  @@map("activity_log")
}

